<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ transcript.title }} - Video Transcription App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        dark: {
                            800: '#1f2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .timeline-segment:hover {
                @apply bg-dark-900 cursor-pointer;
            }
            .timeline-segment.active {
                @apply bg-primary-900;
            }
        }
    </style>
</head>
<body class="bg-dark-900 text-white min-h-screen">
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-800 rounded-lg shadow-lg max-w-md w-full p-6">
            <h3 class="text-lg font-medium mb-4">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to delete this transcript? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Cancel</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-12">
            <h1 class="text-3xl font-bold text-primary-400">Video Transcriber</h1>
            <nav class="flex space-x-6">
                <a href="/" class="text-primary-300 hover:text-primary-400 transition">Home</a>
                <a href="/dashboard" class="text-primary-300 hover:text-primary-400 transition">Dashboard</a>
            </nav>
        </header>

        <main class="max-w-6xl mx-auto">
            <section class="mb-12">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold">{{ transcript.title }}</h2>
                        <p class="text-gray-400">{{ transcript.original_filename }}</p>
                    </div>
                    <div class="flex space-x-3">
                        <a href="/download/{{ transcript.id }}" class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download
                        </a>
                        <button onclick="openVideoLocation()" class="bg-dark-800 hover:bg-dark-700 text-white font-medium py-2 px-4 rounded-lg border border-gray-700 transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            View Video
                        </button>
                        <button onclick="deleteTranscript()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <!-- Transcript Metadata -->
                    <div class="lg:col-span-3">
                        <div class="bg-dark-800 rounded-xl p-6 shadow-lg mb-6">
                            <h3 class="text-lg font-medium mb-4 text-primary-300">Transcript Details</h3>
                            <div class="space-y-4">
                                <div>
                                    <p class="text-sm text-gray-400">Date</p>
                                    <p>{{ transcript.date.split('T')[0] }}</p>
                                </div>
                                {% if transcript.topic %}
                                <div>
                                    <p class="text-sm text-gray-400">Topic</p>
                                    <p>{{ transcript.topic }}</p>
                                </div>
                                {% endif %}
                                <div>
                                    <p class="text-sm text-gray-400">File</p>
                                    <p class="truncate">{{ transcript.original_filename }}</p>
                                </div>
                                {% if transcript.youtube_url is defined and transcript.youtube_url %}
                                <div>
                                    <p class="text-sm text-gray-400">YouTube</p>
                                    <a href="{{ transcript.youtube_url }}" target="_blank" class="text-primary-400 hover:text-primary-300 truncate">
                                        {{ transcript.youtube_url }}
                                    </a>
                                </div>
                                {% if transcript.youtube_channel is defined and transcript.youtube_channel %}
                                <div>
                                    <p class="text-sm text-gray-400">Channel</p>
                                    <p class="truncate">{{ transcript.youtube_channel }}</p>
                                </div>
                                {% endif %}
                                {% else %}
                                <div>
                                    <p class="text-sm text-gray-400">Storage Path</p>
                                    <p class="truncate text-xs">{{ transcript.filepath }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="bg-dark-800 rounded-xl p-6 shadow-lg">
                            <h3 class="text-lg font-medium mb-4 text-primary-300">Search Transcript</h3>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input type="text" id="search" class="w-full pl-10 pr-4 py-2 bg-dark-900 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Search in transcript...">
                            </div>
                            <div id="search-results" class="mt-4 max-h-72 overflow-y-auto hidden">
                                <h4 class="text-sm font-medium mb-2 text-primary-300">Results (<span id="results-count">0</span>)</h4>
                                <ul id="results-list" class="space-y-2"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Transcript Content -->
                    <div class="lg:col-span-9">
                        <div class="bg-dark-800 rounded-xl shadow-lg overflow-hidden">
                            <!-- Timeline Navigation -->
                            <div class="bg-dark-900 p-4 border-b border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-lg font-medium">Timeline</h3>
                                    <div class="text-sm text-gray-400">
                                        <span id="current-time">0:00</span> / <span id="total-time">{{ (transcript.segments[-1].end / 60)|int }}:{{ '%02d' % ((transcript.segments[-1].end % 60)|int) }}</span>
                                    </div>
                                </div>
                                <div class="relative h-8 bg-dark-800 rounded-lg overflow-hidden" id="timeline-container">
                                    <div class="absolute top-0 left-0 h-full bg-primary-900 opacity-30" id="timeline-progress" style="width: 0%;"></div>
                                    {% for segment in transcript.segments %}
                                    <div 
                                        class="timeline-segment absolute top-0 h-full hover:bg-opacity-50 transition duration-150" 
                                        style="left: {{ (segment.start / transcript.segments[-1].end * 100)|float }}%; width: {{ ((segment.end - segment.start) / transcript.segments[-1].end * 100)|float }}%;"
                                        data-start="{{ segment.start }}"
                                        data-end="{{ segment.end }}"
                                        data-index="{{ loop.index0 }}"
                                        onclick="jumpToSegment({{ loop.index0 }})"
                                        title="{{ '%02d:%02d' % ((segment.start / 60)|int, (segment.start % 60)|int) }} - {{ '%02d:%02d' % ((segment.end / 60)|int, (segment.end % 60)|int) }}"
                                    ></div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Transcript Text -->
                            <div class="p-6 max-h-[70vh] overflow-y-auto" id="transcript-content">
                                {% for segment in transcript.segments %}
                                <div 
                                    class="mb-4 p-3 rounded-lg hover:bg-dark-900 transition segment" 
                                    id="segment-{{ loop.index0 }}" 
                                    data-start="{{ segment.start }}" 
                                    data-end="{{ segment.end }}"
                                    onclick="jumpToSegment({{ loop.index0 }})"
                                >
                                    <div class="text-primary-400 text-sm mb-1">
                                        {{ '%02d:%02d' % ((segment.start / 60)|int, (segment.start % 60)|int) }} - {{ '%02d:%02d' % ((segment.end / 60)|int, (segment.end % 60)|int) }}
                                    </div>
                                    <p class="segment-text">{{ segment.text }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const segments = JSON.parse('{{ transcript.segments|tojson }}');
        let currentSegmentIndex = -1;
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function jumpToSegment(index) {
            // Update current segment
            if (currentSegmentIndex >= 0) {
                document.getElementById(`segment-${currentSegmentIndex}`).classList.remove('bg-dark-900');
                document.querySelectorAll('.timeline-segment')[currentSegmentIndex].classList.remove('active');
            }
            
            currentSegmentIndex = index;
            const segment = segments[index];
            
            // Update UI
            document.getElementById(`segment-${index}`).classList.add('bg-dark-900');
            document.querySelectorAll('.timeline-segment')[index].classList.add('active');
            document.getElementById('current-time').textContent = formatTime(segment.start);
            
            // Scroll to segment
            document.getElementById(`segment-${index}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Update timeline progress
            document.getElementById('timeline-progress').style.width = `${(segment.start / segments[segments.length - 1].end * 100)}%`;
            
            // In a full implementation, this would control video playback
            console.log(`Jumping to ${formatTime(segment.start)} - ${segment.text}`);
        }
        
        function openVideoLocation() {
            // In a real app, this would either open the file or show a modal with the path
            alert('Video file location: {{ transcript.filepath }}');
        }
        
        function deleteTranscript() {
            // Show the confirmation modal
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        
        function highlightSearchTermInSegments(searchTerm) {
            if (!searchTerm || searchTerm.length < 2) return [];
            
            const segmentElements = document.querySelectorAll('.segment-text');
            const results = [];
            
            // Loop through all segments to find matches
            segments.forEach((segment, index) => {
                const segmentText = segment.text.toLowerCase();
                if (segmentText.includes(searchTerm.toLowerCase())) {
                    // Highlight the text with a span
                    const segmentEl = segmentElements[index];
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    segmentEl.innerHTML = segment.text.replace(regex, '<span class="bg-primary-900 text-primary-200">$1</span>');
                    
                    // Add to results
                    results.push({
                        index: index,
                        text: segment.text,
                        start: segment.start
                    });
                }
            });
            
            // Jump to the first result if any
            if (results.length > 0) {
                jumpToSegment(results[0].index);
            }
            
            return results;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search');
            const searchResults = document.getElementById('search-results');
            const resultsList = document.getElementById('results-list');
            const resultsCount = document.getElementById('results-count');
            
            // Delete modal functionality
            const deleteModal = document.getElementById('delete-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            const confirmDeleteBtn = document.getElementById('confirm-delete');
            
            // Handle cancel button
            cancelDeleteBtn.addEventListener('click', function() {
                deleteModal.classList.add('hidden');
            });
            
            // Close modal on outside click
            deleteModal.addEventListener('click', function(event) {
                if (event.target === deleteModal) {
                    deleteModal.classList.add('hidden');
                }
            });
            
            // Handle confirm delete
            confirmDeleteBtn.addEventListener('click', function() {
                // Send delete request
                fetch(`/delete/{{ transcript.id }}`, {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Redirect to dashboard after successful deletion
                        window.location.href = '/dashboard';
                    } else {
                        alert('Error deleting transcript: ' + (data.error || 'Unknown error'));
                        deleteModal.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the transcript');
                    deleteModal.classList.add('hidden');
                });
            });
            
            // Check for search parameter in URL (coming from global search)
            const urlParams = new URLSearchParams(window.location.search);
            const urlSearchTerm = urlParams.get('search');
            
            if (urlSearchTerm) {
                // Set the search input value
                searchInput.value = urlSearchTerm;
                
                // Perform the search
                const results = highlightSearchTermInSegments(urlSearchTerm);
                
                // Update results display
                resultsList.innerHTML = '';
                results.forEach(result => {
                    const item = document.createElement('li');
                    item.className = 'p-2 rounded-lg hover:bg-dark-900 cursor-pointer';
                    
                    const time = document.createElement('div');
                    time.className = 'text-xs text-primary-400';
                    time.textContent = formatTime(result.start);
                    
                    // Get the text with highlighted search term
                    const textEl = document.createElement('p');
                    textEl.className = 'text-sm';
                    
                    const regex = new RegExp(`(${urlSearchTerm})`, 'gi');
                    const highlightedText = result.text.replace(regex, '<span class="bg-primary-900 text-primary-200">$1</span>');
                    textEl.innerHTML = highlightedText;
                    
                    item.appendChild(time);
                    item.appendChild(textEl);
                    
                    item.addEventListener('click', () => {
                        jumpToSegment(result.index);
                    });
                    
                    resultsList.appendChild(item);
                });
                
                // Update count and show results
                resultsCount.textContent = results.length;
                
                if (results.length > 0) {
                    searchResults.classList.remove('hidden');
                }
            }
            
            // Regular search functionality
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                // Clear existing highlights
                document.querySelectorAll('.segment-text').forEach((el, index) => {
                    el.textContent = segments[index].text;
                });
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                if (searchTerm.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                // Add a slight delay for better performance
                searchTimeout = setTimeout(() => {
                    // Search in segments and highlight matches
                    const results = highlightSearchTermInSegments(searchTerm);
                    
                    // Update results list
                    resultsList.innerHTML = '';
                    results.forEach(result => {
                        const item = document.createElement('li');
                        item.className = 'p-2 rounded-lg hover:bg-dark-900 cursor-pointer';
                        
                        const time = document.createElement('div');
                        time.className = 'text-xs text-primary-400';
                        time.textContent = formatTime(result.start);
                        
                        // Get the text with highlighted search term
                        const textEl = document.createElement('p');
                        textEl.className = 'text-sm';
                        
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        const highlightedText = result.text.replace(regex, '<span class="bg-primary-900 text-primary-200">$1</span>');
                        textEl.innerHTML = highlightedText;
                        
                        item.appendChild(time);
                        item.appendChild(textEl);
                        
                        item.addEventListener('click', () => {
                            jumpToSegment(result.index);
                        });
                        
                        resultsList.appendChild(item);
                    });
                    
                    // Update count and show results
                    resultsCount.textContent = results.length;
                    
                    if (results.length > 0) {
                        searchResults.classList.remove('hidden');
                    } else {
                        searchResults.classList.add('hidden');
                    }
                }, 300);
            });
        });
    </script>
</body>
</html>