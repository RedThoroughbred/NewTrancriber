<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ transcript.title }} - Video Transcription App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        dark: {
                            800: '#1f2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .timeline-segment:hover {
                @apply bg-dark-900 cursor-pointer;
            }
            .timeline-segment.active {
                @apply bg-primary-900;
            }
        }
    </style>
</head>
<body class="bg-dark-900 text-white min-h-screen">
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-800 rounded-lg shadow-lg max-w-md w-full p-6">
            <h3 class="text-lg font-medium mb-4">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to delete this transcript? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Cancel</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-12">
            <h1 class="text-3xl font-bold text-primary-400">Video Transcriber</h1>
            <nav class="flex space-x-6">
                <a href="/" class="text-primary-300 hover:text-primary-400 transition">Home</a>
                <a href="/dashboard" class="text-primary-300 hover:text-primary-400 transition">Dashboard</a>
            </nav>
        </header>

        <main class="max-w-6xl mx-auto">
            <section class="mb-12">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold">{{ transcript.title }}</h2>
                        <p class="text-gray-400">{{ transcript.original_filename }}</p>
                    </div>
                    <div class="flex space-x-3">
                        <a href="/download/{{ transcript.id }}" class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download
                        </a>
                        <button onclick="openVideoLocation()" class="bg-dark-800 hover:bg-dark-700 text-white font-medium py-2 px-4 rounded-lg border border-gray-700 transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            View Video
                        </button>
                        <button onclick="deleteTranscript()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <!-- Sidebar (Tabbed Interface) -->
                    <div class="lg:col-span-3">
                        <!-- Tabs Navigation -->
                        <div class="bg-dark-800 rounded-xl mb-6 overflow-hidden">
                            <div class="flex border-b border-dark-900">
                                <button id="tab-tools" class="tab-btn flex-1 py-3 px-4 text-sm font-medium text-primary-300 border-b-2 border-primary-600 bg-dark-900 bg-opacity-30">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    Tools
                                </button>
                                <button id="tab-details" class="tab-btn flex-1 py-3 px-4 text-sm font-medium text-gray-400 hover:text-gray-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Details
                                </button>
                                <button id="tab-results" class="tab-btn flex-1 py-3 px-4 text-sm font-medium text-gray-400 hover:text-gray-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                    Results
                                </button>
                            </div>

                            <!-- Tab Content -->
                            <!-- Tools Tab -->
                            <div id="content-tools" class="tab-content p-6">
                                <h3 class="text-lg font-medium mb-4 text-primary-300">AI Analysis Tools</h3>
                                <div class="space-y-4">
                                    <button id="generate-summary-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        Generate Summary
                                    </button>
                                    
                                    <button id="extract-topics-btn" class="w-full bg-primary-800 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                        </svg>
                                        Extract Topics
                                    </button>
                                    
                                    <button id="extract-action-items-btn" class="w-full bg-green-800 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                        </svg>
                                        Extract Action Items
                                    </button>
                                </div>
                            </div>

                            <!-- Details Tab -->
                            <div id="content-details" class="tab-content p-6 hidden">
                                <h3 class="text-lg font-medium mb-4 text-primary-300">Transcript Details</h3>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-sm text-gray-400">Date</p>
                                        <p>{{ transcript.date.split('T')[0] }}</p>
                                    </div>
                                    {% if transcript.topic %}
                                    <div>
                                        <p class="text-sm text-gray-400 flex items-center justify-between">
                                            <span>Topic</span>
                                            <button id="edit-topic-tag-btn" class="text-xs text-primary-400 hover:text-primary-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                            </button>
                                        </p>
                                        <div id="topic-tag-display" class="max-w-full truncate">{{ transcript.topic }}</div>
                                        
                                        <!-- Topic tag edit form -->
                                        <div id="topic-tag-edit-form" class="mt-2 hidden">
                                            <input 
                                                type="text" 
                                                id="topic-tag-input" 
                                                class="w-full px-3 py-2 text-sm bg-dark-900 border border-gray-700 rounded-lg"
                                                value="{{ transcript.topic }}"
                                            >
                                            <div class="flex justify-end space-x-2 mt-2">
                                                <button id="topic-tag-cancel" class="text-xs px-2 py-1 bg-gray-700 rounded-md hover:bg-gray-600">Cancel</button>
                                                <button id="topic-tag-save" class="text-xs px-2 py-1 bg-primary-600 rounded-md hover:bg-primary-500">Save</button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <p class="text-sm text-gray-400">File</p>
                                        <p class="truncate">{{ transcript.original_filename }}</p>
                                    </div>
                                    {% if transcript.youtube_url is defined and transcript.youtube_url %}
                                    <div>
                                        <p class="text-sm text-gray-400">YouTube</p>
                                        <a href="{{ transcript.youtube_url }}" target="_blank" class="text-primary-400 hover:text-primary-300 truncate">
                                            {{ transcript.youtube_url }}
                                        </a>
                                    </div>
                                    {% if transcript.youtube_channel is defined and transcript.youtube_channel %}
                                    <div>
                                        <p class="text-sm text-gray-400">Channel</p>
                                        <p class="truncate">{{ transcript.youtube_channel }}</p>
                                    </div>
                                    {% endif %}
                                    {% else %}
                                    <div>
                                        <p class="text-sm text-gray-400">Storage Path</p>
                                        <p class="truncate text-xs">{{ transcript.filepath }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Results Tab -->
                            <div id="content-results" class="tab-content p-6 hidden">
                                <h3 class="text-lg font-medium mb-4 text-primary-300">Analysis Results</h3>
                                
                                <!-- Summary Accordion -->
                                {% if transcript.summary is defined and transcript.summary %}
                                <div class="accordion-item mb-3 border border-dark-900 rounded-lg overflow-hidden">
                                    <button class="accordion-header w-full bg-dark-900 p-3 flex justify-between items-center">
                                        <div class="flex items-center">
                                            <span class="font-medium text-primary-300">Summary</span>
                                            <span class="ml-2 text-xs bg-primary-900 text-primary-300 px-2 py-0.5 rounded-full">Saved</span>
                                        </div>
                                        <svg class="accordion-icon w-5 h-5 text-primary-300 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div class="accordion-content bg-dark-800 p-4 hidden">
                                        <div class="flex justify-between items-center mb-2">
                                            <div></div>
                                            <button id="edit-summary-btn" class="text-xs text-primary-400 hover:text-primary-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                                Edit
                                            </button>
                                        </div>
                                        <div id="summary-display" class="text-sm whitespace-pre-wrap">{{ transcript.summary }}</div>
                                        
                                        <!-- Edit form (hidden by default) -->
                                        <div id="summary-edit-form" class="mt-3 hidden">
                                            <textarea id="summary-edit-textarea" class="w-full h-40 px-3 py-2 text-sm bg-dark-900 border border-gray-700 rounded-lg resize-none"></textarea>
                                            <div class="flex justify-end space-x-2 mt-2">
                                                <button id="summary-edit-cancel" class="text-xs px-2 py-1 bg-gray-700 rounded-md hover:bg-gray-600">Cancel</button>
                                                <button id="summary-edit-save" class="text-xs px-2 py-1 bg-primary-600 rounded-md hover:bg-primary-500">Save</button>
                                                <button id="summary-edit-delete" class="text-xs px-2 py-1 bg-red-600 rounded-md hover:bg-red-500">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Topics Accordion -->
                                {% if transcript.topics %}
                                <div class="accordion-item mb-3 border border-dark-900 rounded-lg overflow-hidden">
                                    <button class="accordion-header w-full bg-dark-900 p-3 flex justify-between items-center">
                                        <div class="flex items-center">
                                            <span class="font-medium text-primary-300">Topics</span>
                                            <span class="ml-2 text-xs bg-primary-900 text-primary-300 px-2 py-0.5 rounded-full">Saved</span>
                                        </div>
                                        <svg class="accordion-icon w-5 h-5 text-primary-300 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div class="accordion-content bg-dark-800 p-4 hidden">
                                        <div class="flex justify-between items-center mb-2">
                                            <div></div>
                                            <button id="edit-ai-topics-btn" class="text-xs text-primary-400 hover:text-primary-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                                Edit
                                            </button>
                                        </div>
                                        
                                        <!-- Topics content (view mode) -->
                                        <div id="topics-content" class="text-sm">
                                            <div class="space-y-3">
                                            {% for topic in transcript.topics %}
                                                <div>
                                                    <h5 class="font-medium text-primary-300">{{ topic.name }}</h5>
                                                    <ul class="list-disc pl-5 space-y-1">
                                                    {% for point in topic.points %}
                                                        <li>{{ point }}</li>
                                                    {% endfor %}
                                                    </ul>
                                                </div>
                                            {% endfor %}
                                            </div>
                                        </div>
                                        
                                        <!-- Topics edit form (hidden by default) -->
                                        <div id="topics-edit-container" class="hidden mt-2">
                                            <div id="topics-editor" class="space-y-3">
                                                <!-- Topics will be added here dynamically -->
                                            </div>
                                            
                                            <button id="topics-add-btn" class="mt-3 text-xs flex items-center text-primary-400 hover:text-primary-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                </svg>
                                                Add Topic
                                            </button>
                                            
                                            <div class="flex justify-end space-x-2 mt-3">
                                                <button id="topics-edit-cancel" class="text-xs px-2 py-1 bg-gray-700 rounded-md hover:bg-gray-600">Cancel</button>
                                                <button id="topics-edit-save" class="text-xs px-2 py-1 bg-primary-600 rounded-md hover:bg-primary-500">Save</button>
                                                <button id="topics-edit-delete" class="text-xs px-2 py-1 bg-red-600 rounded-md hover:bg-red-500">Delete All</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Action Items Accordion -->
                                {% if transcript.action_items %}
                                <div class="accordion-item mb-3 border border-dark-900 rounded-lg overflow-hidden">
                                    <button class="accordion-header w-full bg-dark-900 p-3 flex justify-between items-center">
                                        <div class="flex items-center">
                                            <span class="font-medium text-primary-300">Action Items</span>
                                            <span class="ml-2 text-xs bg-primary-900 text-primary-300 px-2 py-0.5 rounded-full">Saved</span>
                                        </div>
                                        <svg class="accordion-icon w-5 h-5 text-primary-300 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div class="accordion-content bg-dark-800 p-4 hidden">
                                        <div class="flex justify-between items-center mb-2">
                                            <div></div>
                                            <button id="edit-action-items-btn" class="text-xs text-primary-400 hover:text-primary-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                                Edit
                                            </button>
                                        </div>
                                        
                                        <!-- Action Items content (view mode) -->
                                        <div id="action-items-content" class="text-sm">
                                            <div class="space-y-4">
                                                <!-- Action items will be populated by JS -->
                                            </div>
                                        </div>
                                        
                                        <!-- Action Items edit form (hidden by default) -->
                                        <div id="action-items-edit-container" class="hidden mt-2">
                                            <div id="action-items-editor" class="space-y-3">
                                                <!-- Action items will be added here dynamically -->
                                            </div>
                                            
                                            <button id="action-items-add-btn" class="mt-3 text-xs flex items-center text-primary-400 hover:text-primary-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                </svg>
                                                Add Action Item
                                            </button>
                                            
                                            <div class="flex justify-end space-x-2 mt-3">
                                                <button id="action-items-edit-cancel" class="text-xs px-2 py-1 bg-gray-700 rounded-md hover:bg-gray-600">Cancel</button>
                                                <button id="action-items-edit-save" class="text-xs px-2 py-1 bg-primary-600 rounded-md hover:bg-primary-500">Save</button>
                                                <button id="action-items-edit-delete" class="text-xs px-2 py-1 bg-red-600 rounded-md hover:bg-red-500">Delete All</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Result containers for newly generated content -->
                                <div id="summary-container" class="bg-dark-900 rounded-lg p-4 mb-3 hidden">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center space-x-2">
                                            <h4 class="text-sm font-medium text-primary-300">Summary</h4>
                                            <span id="summary-cached" class="hidden text-xs bg-primary-900 text-primary-300 px-2 py-0.5 rounded-full">Saved</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button id="save-summary-btn" class="text-xs bg-primary-700 hover:bg-primary-600 text-white px-2 py-1 rounded hidden">
                                                Save
                                            </button>
                                            <button class="summary-close-btn text-gray-400 hover:text-gray-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="summary-content" class="text-sm mt-2"></div>
                                </div>
                                
                                <div id="topics-container" class="bg-dark-900 rounded-lg p-4 mb-3 hidden">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center space-x-2">
                                            <h4 class="text-sm font-medium text-primary-300">Topics</h4>
                                            <span id="topics-cached" class="hidden text-xs bg-primary-900 text-primary-300 px-2 py-0.5 rounded-full">Saved</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button id="edit-ai-topics-btn-generated" class="text-xs text-primary-400 hover:text-primary-300 px-2 py-1 rounded">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                            </button>
                                            <button id="save-topics-btn" class="text-xs bg-primary-700 hover:bg-primary-600 text-white px-2 py-1 rounded hidden">
                                                Save
                                            </button>
                                            <button class="topics-close-btn text-gray-400 hover:text-gray-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="topics-content-new" class="text-sm mt-2"></div>
                                </div>
                                
                                <div id="action-items-container" class="bg-dark-900 rounded-lg p-4 mb-3 hidden">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center space-x-2">
                                            <h4 class="text-sm font-medium text-primary-300">Action Items</h4>
                                            <span id="action-items-cached" class="hidden text-xs bg-primary-900 text-primary-300 px-2 py-0.5 rounded-full">Saved</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button id="edit-action-items-btn-generated" class="text-xs text-primary-400 hover:text-primary-300 px-2 py-1 rounded">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                            </button>
                                            <button id="save-action-items-btn" class="text-xs bg-primary-700 hover:bg-primary-600 text-white px-2 py-1 rounded hidden">
                                                Save
                                            </button>
                                            <button class="action-items-close-btn text-gray-400 hover:text-gray-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="action-items-content-new" class="text-sm mt-2">
                                        <div class="space-y-4"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Panel (Always Visible) -->
                        <div class="bg-dark-800 rounded-xl p-6 shadow-lg sticky top-4">
                            <h3 class="text-lg font-medium mb-4 text-primary-300">Search Transcript</h3>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input type="text" id="search" class="w-full pl-10 pr-4 py-2 bg-dark-900 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Search in transcript...">
                            </div>
                            <div id="search-results" class="mt-4 max-h-72 overflow-y-auto hidden">
                                <h4 class="text-sm font-medium mb-2 text-primary-300">Results (<span id="results-count">0</span>)</h4>
                                <ul id="results-list" class="space-y-2"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Transcript Content -->
                    <div class="lg:col-span-9">
                        <div class="bg-dark-800 rounded-xl shadow-lg overflow-hidden">
                            <!-- Sticky Timeline Navigation -->
                            <div class="bg-dark-900 p-4 border-b border-gray-700 sticky top-0 z-10">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-lg font-medium">Timeline</h3>
                                    <div class="text-sm text-gray-400">
                                        <span id="current-time">0:00</span> / <span id="total-time">{{ (transcript.segments[-1].end / 60)|int }}:{{ '%02d' % ((transcript.segments[-1].end % 60)|int) }}</span>
                                    </div>
                                </div>
                                <div class="relative h-8 bg-dark-800 rounded-lg overflow-hidden" id="timeline-container">
                                    <div class="absolute top-0 left-0 h-full bg-primary-900 opacity-30" id="timeline-progress" style="width: 0%;"></div>
                                    {% for segment in transcript.segments %}
                                    <div 
                                        class="timeline-segment absolute top-0 h-full hover:bg-opacity-50 transition duration-150" 
                                        style="left: {{ (segment.start / transcript.segments[-1].end * 100)|float }}%; width: {{ ((segment.end - segment.start) / transcript.segments[-1].end * 100)|float }}%;"
                                        data-start="{{ segment.start }}"
                                        data-end="{{ segment.end }}"
                                        data-index="{{ loop.index0 }}"
                                        onclick="jumpToSegment({{ loop.index0 }})"
                                        title="{{ '%02d:%02d' % ((segment.start / 60)|int, (segment.start % 60)|int) }} - {{ '%02d:%02d' % ((segment.end / 60)|int, (segment.end % 60)|int) }}"
                                    ></div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Transcript Text -->
                            <div class="p-6 max-h-[calc(100vh-210px)] overflow-y-auto" id="transcript-content">
                                {% for segment in transcript.segments %}
                                <div 
                                    class="mb-4 p-3 rounded-lg hover:bg-dark-900 transition segment" 
                                    id="segment-{{ loop.index0 }}" 
                                    data-start="{{ segment.start }}" 
                                    data-end="{{ segment.end }}"
                                    onclick="jumpToSegment({{ loop.index0 }})"
                                >
                                    <div class="text-primary-400 text-sm mb-1">
                                        {{ '%02d:%02d' % ((segment.start / 60)|int, (segment.start % 60)|int) }} - {{ '%02d:%02d' % ((segment.end / 60)|int, (segment.end % 60)|int) }}
                                    </div>
                                    <p class="segment-text">{{ segment.text }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const segments = JSON.parse('{{ transcript.segments|tojson }}');
        let currentSegmentIndex = -1;
        
        // Define a global switchTab function
        function switchTab(tabId) {
            console.log("Switching to tab:", tabId);
            
            // Get all tab elements
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Hide all content panels
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('border-b-2', 'border-primary-600', 'bg-dark-900', 'bg-opacity-30', 'text-primary-300');
                btn.classList.add('text-gray-400');
            });
            
            // Show the selected content panel
            const contentElement = document.getElementById(`content-${tabId}`);
            if (contentElement) {
                contentElement.classList.remove('hidden');
                console.log(`Showing content: content-${tabId}`);
            } else {
                console.error(`Content panel not found: content-${tabId}`);
            }
            
            // Add active class to selected button
            const buttonElement = document.getElementById(`tab-${tabId}`);
            if (buttonElement) {
                buttonElement.classList.remove('text-gray-400');
                buttonElement.classList.add('border-b-2', 'border-primary-600', 'bg-dark-900', 'bg-opacity-30', 'text-primary-300');
                console.log(`Highlighting button: tab-${tabId}`);
            } else {
                console.error(`Button not found: tab-${tabId}`);
            }
        }
        
        // Tab switching functionality
        function setupTabs() {
            console.log("Setting up tab functionality");
            
            // Get all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            console.log("Found tab buttons:", tabButtons.length);
            
            // Attach click event to each tab button
            tabButtons.forEach((button, index) => {
                console.log(`Setting up button ${index}:`, button.id);
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log("Tab button clicked:", this.id);
                    // Get the tab id from the button id
                    const tabId = this.id.replace('tab-', '');
                    switchTab(tabId);
                });
            });
            
            // Set the global switchTab function
            window.switchTab = switchTab;
        }
        
        // Setup accordion functionality
        function setupAccordions() {
            console.log("Setting up accordion functionality");
            
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            console.log("Found accordion headers:", accordionHeaders.length);
            
            accordionHeaders.forEach((header, index) => {
                console.log(`Setting up accordion ${index}`);
                header.addEventListener('click', function() {
                    console.log("Accordion header clicked");
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.accordion-icon');
                    
                    // Toggle content visibility
                    content.classList.toggle('hidden');
                    console.log("Toggled content visibility:", !content.classList.contains('hidden'));
                    
                    // Rotate icon
                    if (content.classList.contains('hidden')) {
                        icon.classList.remove('rotate-180');
                    } else {
                        icon.classList.add('rotate-180');
                    }
                });
            });
            
            // Open the first accordion by default
            if (accordionHeaders.length > 0) {
                const firstContent = accordionHeaders[0].nextElementSibling;
                const firstIcon = accordionHeaders[0].querySelector('.accordion-icon');
                
                firstContent.classList.remove('hidden');
                firstIcon.classList.add('rotate-180');
                console.log("Opened first accordion by default");
            }
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function jumpToSegment(index) {
            // Update current segment
            if (currentSegmentIndex >= 0) {
                document.getElementById(`segment-${currentSegmentIndex}`).classList.remove('bg-dark-900');
                document.querySelectorAll('.timeline-segment')[currentSegmentIndex].classList.remove('active');
            }
            
            currentSegmentIndex = index;
            const segment = segments[index];
            
            // Update UI
            document.getElementById(`segment-${index}`).classList.add('bg-dark-900');
            document.querySelectorAll('.timeline-segment')[index].classList.add('active');
            document.getElementById('current-time').textContent = formatTime(segment.start);
            
            // Scroll to segment
            document.getElementById(`segment-${index}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Update timeline progress
            document.getElementById('timeline-progress').style.width = `${(segment.start / segments[segments.length - 1].end * 100)}%`;
            
            // In a full implementation, this would control video playback
            console.log(`Jumping to ${formatTime(segment.start)} - ${segment.text}`);
        }
        
        function openVideoLocation() {
            // In a real app, this would either open the file or show a modal with the path
            alert('Video file location: {{ transcript.filepath }}');
        }
        
        function deleteTranscript() {
            // Show the confirmation modal
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        
        function highlightSearchTermInSegments(searchTerm) {
            if (!searchTerm || searchTerm.length < 2) return [];
            
            const segmentElements = document.querySelectorAll('.segment-text');
            const results = [];
            
            // Loop through all segments to find matches
            segments.forEach((segment, index) => {
                const segmentText = segment.text.toLowerCase();
                if (segmentText.includes(searchTerm.toLowerCase())) {
                    // Highlight the text with a span
                    const segmentEl = segmentElements[index];
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    segmentEl.innerHTML = segment.text.replace(regex, '<span class="bg-primary-900 text-primary-200">$1</span>');
                    
                    // Add to results
                    results.push({
                        index: index,
                        text: segment.text,
                        start: segment.start
                    });
                }
            });
            
            // Jump to the first result if any
            if (results.length > 0) {
                jumpToSegment(results[0].index);
            }
            
            return results;
        }
        
        // Function to convert newlines to <br> and bullet points
        function formatLLMOutput(text) {
            if (!text) return '';
            
            // First, handle bullet points (lines starting with - or *)
            const lines = text.split('\n');
            const formattedLines = lines.map(line => {
                if (line.trim().startsWith('-') || line.trim().startsWith('*')) {
                    return `<li>${line.trim().substring(1).trim()}</li>`;
                }
                return line;
            });
            
            let formattedText = formattedLines.join('\n');
            
            // Wrap bullet point lists in <ul>
            formattedText = formattedText.replace(/<li>.*?<\/li>(\n<li>.*?<\/li>)+/g, match => {
                return `<ul class="list-disc pl-5 space-y-1">${match}</ul>`;
            });
            
            // Replace remaining newlines with <br>
            formattedText = formattedText.replace(/\n/g, '<br>');
            
            return formattedText;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing UI");
            
            // Initialize tabs and accordions
            setupTabs();
            setupAccordions();
            
            const searchInput = document.getElementById('search');
            const searchResults = document.getElementById('search-results');
            const resultsList = document.getElementById('results-list');
            const resultsCount = document.getElementById('results-count');
            
            // Delete modal functionality
            const deleteModal = document.getElementById('delete-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            const confirmDeleteBtn = document.getElementById('confirm-delete');
            
            // LLM Analysis UI elements
            const generateSummaryBtn = document.getElementById('generate-summary-btn');
            const extractTopicsBtn = document.getElementById('extract-topics-btn');
            const summaryContainer = document.getElementById('summary-container');
            const topicsContainer = document.getElementById('topics-container');
            const summaryContent = document.getElementById('summary-content');
            const topicsContent = document.getElementById('topics-content');
            const summaryCloseBtn = document.querySelector('.summary-close-btn');
            const topicsCloseBtn = document.querySelector('.topics-close-btn');
            
            // Variables to store the current summary and topics
            let currentSummary = '';
            let currentTopics = [];
            
            // Handle save summary button
            const saveSummaryBtn = document.getElementById('save-summary-btn');
            saveSummaryBtn.addEventListener('click', function() {
                // Show saving state
                saveSummaryBtn.disabled = true;
                saveSummaryBtn.textContent = 'Saving...';
                
                // Make API request to save the summary
                fetch(`/api/transcripts/{{ transcript.id }}/save-summary`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        summary: currentSummary
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show saved indicator
                        document.getElementById('summary-cached').classList.remove('hidden');
                        saveSummaryBtn.classList.add('hidden');
                    } else {
                        alert('Failed to save summary');
                    }
                    
                    // Reset button
                    saveSummaryBtn.disabled = false;
                    saveSummaryBtn.textContent = 'Save';
                })
                .catch(error => {
                    console.error('Error saving summary:', error);
                    alert('Error saving summary');
                    
                    // Reset button
                    saveSummaryBtn.disabled = false;
                    saveSummaryBtn.textContent = 'Save';
                });
            });
            
            // Handle save topics button
            const saveTopicsBtn = document.getElementById('save-topics-btn');
            saveTopicsBtn.addEventListener('click', function() {
                // Show saving state
                saveTopicsBtn.disabled = true;
                saveTopicsBtn.textContent = 'Saving...';
                
                // Make API request to save the topics
                fetch(`/api/transcripts/{{ transcript.id }}/save-topics`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        topics: currentTopics
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show saved indicator
                        document.getElementById('topics-cached').classList.remove('hidden');
                        saveTopicsBtn.classList.add('hidden');
                    } else {
                        alert('Failed to save topics');
                    }
                    
                    // Reset button
                    saveTopicsBtn.disabled = false;
                    saveTopicsBtn.textContent = 'Save';
                })
                .catch(error => {
                    console.error('Error saving topics:', error);
                    alert('Error saving topics');
                    
                    // Reset button
                    saveTopicsBtn.disabled = false;
                    saveTopicsBtn.textContent = 'Save';
                });
            });
            
            // Handle generate summary button
            generateSummaryBtn.addEventListener('click', function() {
                // Show loading state
                generateSummaryBtn.disabled = true;
                generateSummaryBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
                
                // Make API request
                fetch(`/api/transcripts/{{ transcript.id }}/summary`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('API response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Store the summary
                        currentSummary = data.summary;
                        
                        // Format and display summary
                        summaryContent.innerHTML = formatLLMOutput(data.summary);
                        summaryContainer.classList.remove('hidden');
                        
                        // Show cached indicator or save button
                        if (data.cached) {
                            document.getElementById('summary-cached').classList.remove('hidden');
                            saveSummaryBtn.classList.add('hidden');
                        } else {
                            document.getElementById('summary-cached').classList.add('hidden');
                            saveSummaryBtn.classList.remove('hidden');
                        }
                        
                        // Switch to the Results tab
                        window.switchTab('results');
                        
                        // Reset button
                        generateSummaryBtn.disabled = false;
                        generateSummaryBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Generate Summary';
                    })
                    .catch(error => {
                        console.error('Error generating summary:', error);
                        summaryContent.innerHTML = 'Error generating summary. Make sure Ollama is running locally.<br><span class="text-primary-400">Run: ollama serve</span>';
                        summaryContainer.classList.remove('hidden');
                        
                        // Switch to the Results tab
                        window.switchTab('results');
                        
                        // Reset button
                        generateSummaryBtn.disabled = false;
                        generateSummaryBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Generate Summary';
                    });
            });
            
            // Topic editing functionality 
            const editAITopicsBtn = document.getElementById('edit-ai-topics-btn');
            const editAITopicsBtnGenerated = document.getElementById('edit-ai-topics-btn-generated');
            const topicsEditContainer = document.getElementById('topics-edit-container');
            const topicsEditor = document.getElementById('topics-editor');
            const topicsAddBtn = document.getElementById('topics-add-btn');
            const topicsEditCancel = document.getElementById('topics-edit-cancel');
            const topicsEditSave = document.getElementById('topics-edit-save');
            const topicsEditDelete = document.getElementById('topics-edit-delete');
            
            // Helper function to create a topic editor element
            function createTopicEditorElement(topic = { name: '', points: [''] }) {
                const topicId = 'topic-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
                const topicEl = document.createElement('div');
                topicEl.className = 'topic-item bg-dark-900 p-3 rounded-md';
                topicEl.dataset.id = topicId;
                
                // Create the topic header with name input and delete button
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-2';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'bg-dark-800 border border-gray-700 rounded px-2 py-1 text-sm w-full mr-2';
                nameInput.placeholder = 'Topic name';
                nameInput.value = topic.name;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 hover:text-red-300';
                deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                deleteBtn.addEventListener('click', function() {
                    topicEl.remove();
                });
                
                header.appendChild(nameInput);
                header.appendChild(deleteBtn);
                topicEl.appendChild(header);
                
                // Create the points container
                const pointsContainer = document.createElement('div');
                pointsContainer.className = 'points-container space-y-2';
                
                // Add initial points
                topic.points.forEach(point => {
                    addPointInput(pointsContainer, point);
                });
                
                // Add "Add Point" button
                const addPointBtn = document.createElement('button');
                addPointBtn.className = 'text-xs text-primary-400 hover:text-primary-300 mt-2 flex items-center';
                addPointBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Add Point';
                addPointBtn.addEventListener('click', function() {
                    addPointInput(pointsContainer, '');
                });
                
                topicEl.appendChild(pointsContainer);
                topicEl.appendChild(addPointBtn);
                
                return topicEl;
            }
            
            // Helper function to add a point input to a topic
            function addPointInput(container, value = '') {
                const pointWrapper = document.createElement('div');
                pointWrapper.className = 'point-item flex items-center';
                
                const bulletPoint = document.createElement('span');
                bulletPoint.className = 'text-gray-500 mr-2';
                bulletPoint.textContent = '';
                
                const pointInput = document.createElement('input');
                pointInput.type = 'text';
                pointInput.className = 'bg-dark-800 border border-gray-700 rounded px-2 py-1 text-xs flex-grow';
                pointInput.placeholder = 'Point detail';
                pointInput.value = value;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-gray-500 hover:text-gray-400 ml-1';
                removeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
                removeBtn.addEventListener('click', function() {
                    pointWrapper.remove();
                });
                
                pointWrapper.appendChild(bulletPoint);
                pointWrapper.appendChild(pointInput);
                pointWrapper.appendChild(removeBtn);
                
                container.appendChild(pointWrapper);
                return pointWrapper;
            }
            
            // Helper function to collect topic data from the editor
            function collectTopicsData() {
                const topics = [];
                const topicElements = topicsEditor.querySelectorAll('.topic-item');
                
                topicElements.forEach(topicEl => {
                    const nameInput = topicEl.querySelector('input');
                    const name = nameInput.value.trim();
                    
                    // Skip empty topics
                    if (!name) return;
                    
                    const points = [];
                    const pointInputs = topicEl.querySelectorAll('.point-item input');
                    
                    pointInputs.forEach(input => {
                        const point = input.value.trim();
                        if (point) {
                            points.push(point);
                        }
                    });
                    
                    topics.push({
                        name: name,
                        points: points
                    });
                });
                
                return topics;
            }
            
            // Initialize topic editor with existing topics if available
            function setupTopicEditor(button, contentElement) {
                if (button) {
                    // Show edit interface
                    button.addEventListener('click', function() {
                        // Clear existing topics in editor
                        topicsEditor.innerHTML = '';
                        
                        // Add existing topics to editor
                        if (currentTopics && currentTopics.length > 0) {
                            currentTopics.forEach(topic => {
                                const topicEl = createTopicEditorElement(topic);
                                topicsEditor.appendChild(topicEl);
                            });
                        } else {
                            // Add one empty topic if none exist
                            const topicEl = createTopicEditorElement();
                            topicsEditor.appendChild(topicEl);
                        }
                        
                        // Show edit container and hide content
                        if (contentElement) contentElement.classList.add('hidden');
                        topicsEditContainer.classList.remove('hidden');
                    });
                }
            }
            
            // Setup both edit buttons
            setupTopicEditor(editAITopicsBtn, topicsContent);
            setupTopicEditor(editAITopicsBtnGenerated, document.getElementById('topics-content-new'));
                
                // Add a new empty topic
                topicsAddBtn.addEventListener('click', function() {
                    const topicEl = createTopicEditorElement();
                    topicsEditor.appendChild(topicEl);
                });
                
                // Cancel editing
                topicsEditCancel.addEventListener('click', function() {
                    topicsContent.classList.remove('hidden');
                    topicsEditContainer.classList.add('hidden');
                });
                
                // Save topics
                topicsEditSave.addEventListener('click', function() {
                    const topics = collectTopicsData();
                    
                    // Show loading state
                    topicsEditSave.disabled = true;
                    topicsEditSave.textContent = 'Saving...';
                    
                    fetch(`/api/transcripts/{{ transcript.id }}/edit-topics`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            topics: topics
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update current topics
                            currentTopics = topics;
                            
                            // Update display
                            let topicsHtml = '<div class="space-y-3">';
                            topics.forEach(topic => {
                                topicsHtml += `<div>
                                    <h5 class="font-medium text-primary-300">${topic.name}</h5>
                                    <ul class="list-disc pl-5 space-y-1">`;
                                
                                topic.points.forEach(point => {
                                    topicsHtml += `<li>${point}</li>`;
                                });
                                
                                topicsHtml += `</ul></div>`;
                            });
                            topicsHtml += '</div>';
                            
                            topicsContent.innerHTML = topicsHtml;
                            
                            // Show saved indicator
                            document.getElementById('topics-cached').classList.remove('hidden');
                            saveTopicsBtn.classList.add('hidden');
                            
                            // Hide edit container
                            topicsContent.classList.remove('hidden');
                            topicsEditContainer.classList.add('hidden');
                        } else {
                            alert('Failed to save topics');
                        }
                        
                        // Reset button
                        topicsEditSave.disabled = false;
                        topicsEditSave.textContent = 'Save';
                    })
                    .catch(error => {
                        console.error('Error saving topics:', error);
                        alert('Error saving topics');
                        
                        // Reset button
                        topicsEditSave.disabled = false;
                        topicsEditSave.textContent = 'Save';
                    });
                });
                
                // Delete all topics
                topicsEditDelete.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete all topics?')) {
                        // Show loading state
                        topicsEditDelete.disabled = true;
                        topicsEditDelete.textContent = 'Deleting...';
                        
                        fetch(`/api/transcripts/{{ transcript.id }}/edit-topics`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                topics: []
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Reload page to update UI
                                window.location.reload();
                            } else {
                                alert('Failed to delete topics');
                                
                                // Reset button
                                topicsEditDelete.disabled = false;
                                topicsEditDelete.textContent = 'Delete All';
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting topics:', error);
                            alert('Error deleting topics');
                            
                            // Reset button
                            topicsEditDelete.disabled = false;
                            topicsEditDelete.textContent = 'Delete All';
                        });
                    }
                });
            }
            
            // Handle extract topics button
            extractTopicsBtn.addEventListener('click', function() {
                // Show loading state
                extractTopicsBtn.disabled = true;
                extractTopicsBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Extracting...';
                
                // Make API request
                fetch(`/api/transcripts/{{ transcript.id }}/topics`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('API response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Store the topics
                        currentTopics = data.topics;
                        
                        // Format and display topics
                        let topicsHtml = '';
                        
                        if (data.topics && data.topics.length > 0) {
                            topicsHtml = '<div class="space-y-3">';
                            
                            data.topics.forEach(topic => {
                                topicsHtml += `<div>
                                    <h5 class="font-medium text-primary-300">${topic.name}</h5>
                                    <ul class="list-disc pl-5 space-y-1">`;
                                
                                topic.points.forEach(point => {
                                    topicsHtml += `<li>${point}</li>`;
                                });
                                
                                topicsHtml += `</ul></div>`;
                            });
                            
                            topicsHtml += '</div>';
                        } else {
                            topicsHtml = 'No topics found in the transcript.';
                        }
                        
                        // Update both the old topics content and the new one in the tab interface
                        if (topicsContent) topicsContent.innerHTML = topicsHtml;
                        const newTopicsContent = document.getElementById('topics-content-new');
                        if (newTopicsContent) newTopicsContent.innerHTML = topicsHtml;
                        
                        topicsContainer.classList.remove('hidden');
                        
                        // Show cached indicator or save button
                        if (data.cached) {
                            document.getElementById('topics-cached').classList.remove('hidden');
                            saveTopicsBtn.classList.add('hidden');
                        } else {
                            document.getElementById('topics-cached').classList.add('hidden');
                            saveTopicsBtn.classList.remove('hidden');
                        }
                        
                        // Switch to the Results tab
                        window.switchTab('results');
                        
                        // Reset button
                        extractTopicsBtn.disabled = false;
                        extractTopicsBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg> Extract Topics';
                    })
                    .catch(error => {
                        console.error('Error extracting topics:', error);
                        // Update both topic containers with error message
                        const errorMsg = 'Error extracting topics. Make sure Ollama is running locally.<br><span class="text-primary-400">Run: ollama serve</span>';
                        if (topicsContent) topicsContent.innerHTML = errorMsg;
                        const newTopicsContent = document.getElementById('topics-content-new');
                        if (newTopicsContent) newTopicsContent.innerHTML = errorMsg;
                        
                        topicsContainer.classList.remove('hidden');
                        
                        // Switch to the Results tab
                        window.switchTab('results');
                        
                        // Reset button
                        extractTopicsBtn.disabled = false;
                        extractTopicsBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg> Extract Topics';
                    });
            });
            
            // Close summary container
            summaryCloseBtn.addEventListener('click', function() {
                summaryContainer.classList.add('hidden');
            });
            
            // Close topics container
            topicsCloseBtn.addEventListener('click', function() {
                topicsContainer.classList.add('hidden');
            });
            
            // Action Items functionality
            const extractActionItemsBtn = document.getElementById('extract-action-items-btn');
            const actionItemsContainer = document.getElementById('action-items-container');
            const actionItemsContent = document.getElementById('action-items-content').querySelector('div');
            const actionItemsCachedBadge = document.getElementById('action-items-cached');
            const saveActionItemsBtn = document.getElementById('save-action-items-btn');
            const actionItemsCloseBtn = document.querySelector('.action-items-close-btn');
            const editActionItemsBtn = document.getElementById('edit-action-items-btn');
            const editActionItemsBtnGenerated = document.getElementById('edit-action-items-btn-generated');
            const actionItemsEditContainer = document.getElementById('action-items-edit-container');
            const actionItemsEditor = document.getElementById('action-items-editor');
            const actionItemsAddBtn = document.getElementById('action-items-add-btn');
            const actionItemsEditCancel = document.getElementById('action-items-edit-cancel');
            const actionItemsEditSave = document.getElementById('action-items-edit-save');
            const actionItemsEditDelete = document.getElementById('action-items-edit-delete');
            
            // Store current action items
            let currentActionItems = [];
            
            // Helper function to create an action item editor element
            function createActionItemEditorElement(item = { task: '', assignee: '', due: '', context: '', priority: 'Medium' }) {
                const itemEl = document.createElement('div');
                itemEl.className = 'action-item bg-dark-900 p-3 rounded-md';
                
                // Task input
                const taskLabel = document.createElement('label');
                taskLabel.className = 'block text-xs text-gray-400 mb-1';
                taskLabel.textContent = 'Task';
                
                const taskInput = document.createElement('input');
                taskInput.className = 'task-input bg-dark-800 border border-gray-700 rounded px-2 py-1 text-sm w-full mb-2';
                taskInput.placeholder = 'What needs to be done?';
                taskInput.value = item.task;
                
                // Assignee and due date row
                const metaRow = document.createElement('div');
                metaRow.className = 'grid grid-cols-2 gap-2 mb-2';
                
                // Assignee input
                const assigneeLabel = document.createElement('label');
                assigneeLabel.className = 'block text-xs text-gray-400 mb-1';
                assigneeLabel.textContent = 'Assignee';
                
                const assigneeInput = document.createElement('input');
                assigneeInput.className = 'assignee-input bg-dark-800 border border-gray-700 rounded px-2 py-1 text-xs w-full';
                assigneeInput.placeholder = 'Who is responsible?';
                assigneeInput.value = item.assignee || '';
                
                const assigneeWrapper = document.createElement('div');
                assigneeWrapper.appendChild(assigneeLabel);
                assigneeWrapper.appendChild(assigneeInput);
                
                // Due date input
                const dueLabel = document.createElement('label');
                dueLabel.className = 'block text-xs text-gray-400 mb-1';
                dueLabel.textContent = 'Due Date';
                
                const dueInput = document.createElement('input');
                dueInput.className = 'due-input bg-dark-800 border border-gray-700 rounded px-2 py-1 text-xs w-full';
                dueInput.placeholder = 'When is it due?';
                dueInput.value = item.due || '';
                
                const dueWrapper = document.createElement('div');
                dueWrapper.appendChild(dueLabel);
                dueWrapper.appendChild(dueInput);
                
                metaRow.appendChild(assigneeWrapper);
                metaRow.appendChild(dueWrapper);
                
                // Context input
                const contextLabel = document.createElement('label');
                contextLabel.className = 'block text-xs text-gray-400 mb-1';
                contextLabel.textContent = 'Context';
                
                const contextInput = document.createElement('input');
                contextInput.className = 'context-input bg-dark-800 border border-gray-700 rounded px-2 py-1 text-xs w-full mb-2';
                contextInput.placeholder = 'From where in the transcript?';
                contextInput.value = item.context || '';
                
                // Priority select
                const priorityLabel = document.createElement('label');
                priorityLabel.className = 'block text-xs text-gray-400 mb-1';
                priorityLabel.textContent = 'Priority';
                
                const prioritySelect = document.createElement('select');
                prioritySelect.className = 'priority-select bg-dark-800 border border-gray-700 rounded px-2 py-1 text-xs w-full mb-2';
                
                const priorities = ['High', 'Medium', 'Low'];
                priorities.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    option.selected = (p === (item.priority || 'Medium'));
                    prioritySelect.appendChild(option);
                });
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 hover:text-red-300 text-xs flex items-center mt-2';
                deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> Remove';
                deleteBtn.addEventListener('click', function() {
                    itemEl.remove();
                });
                
                // Append all elements
                itemEl.appendChild(taskLabel);
                itemEl.appendChild(taskInput);
                itemEl.appendChild(metaRow);
                itemEl.appendChild(contextLabel);
                itemEl.appendChild(contextInput);
                itemEl.appendChild(priorityLabel);
                itemEl.appendChild(prioritySelect);
                itemEl.appendChild(deleteBtn);
                
                return itemEl;
            }
            
            // Helper function to render an action item in view mode
            function renderActionItem(item) {
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-dark-800 rounded-lg p-3';
                
                // Priority indicator
                let priorityColor;
                switch (item.priority?.toLowerCase()) {
                    case 'high':
                        priorityColor = 'bg-red-700';
                        break;
                    case 'low':
                        priorityColor = 'bg-green-700';
                        break;
                    default:
                        priorityColor = 'bg-yellow-700';
                }
                
                const headerRow = document.createElement('div');
                headerRow.className = 'flex justify-between items-center mb-2';
                
                const taskTitle = document.createElement('h5');
                taskTitle.className = 'font-medium';
                taskTitle.textContent = item.task;
                
                const priorityBadge = document.createElement('span');
                priorityBadge.className = `text-xs ${priorityColor} text-white px-2 py-0.5 rounded-full`;
                priorityBadge.textContent = item.priority || 'Medium';
                
                headerRow.appendChild(taskTitle);
                headerRow.appendChild(priorityBadge);
                
                // Create meta info
                const metaRow = document.createElement('div');
                metaRow.className = 'grid grid-cols-2 gap-2 mb-2';
                
                const assigneeCol = document.createElement('div');
                assigneeCol.innerHTML = `<span class="text-xs text-gray-400">Assignee:</span> <span class="text-xs">${item.assignee || 'Unassigned'}</span>`;
                
                const dueCol = document.createElement('div');
                dueCol.innerHTML = `<span class="text-xs text-gray-400">Due:</span> <span class="text-xs">${item.due || 'Not specified'}</span>`;
                
                metaRow.appendChild(assigneeCol);
                metaRow.appendChild(dueCol);
                
                // Context
                const contextDiv = document.createElement('div');
                if (item.context) {
                    contextDiv.innerHTML = `<span class="text-xs text-gray-400">Context:</span> <span class="text-xs italic">"${item.context}"</span>`;
                }
                
                // Append everything
                itemEl.appendChild(headerRow);
                itemEl.appendChild(metaRow);
                if (item.context) {
                    itemEl.appendChild(contextDiv);
                }
                
                return itemEl;
            }
            
            // Helper function to collect action items data from editor
            function collectActionItemsData() {
                const items = [];
                const itemElements = actionItemsEditor.querySelectorAll('.action-item');
                
                itemElements.forEach(el => {
                    const task = el.querySelector('.task-input').value.trim();
                    if (!task) return; // Skip empty tasks
                    
                    items.push({
                        task: task,
                        assignee: el.querySelector('.assignee-input').value.trim() || 'Unassigned',
                        due: el.querySelector('.due-input').value.trim() || 'Not specified',
                        context: el.querySelector('.context-input').value.trim(),
                        priority: el.querySelector('.priority-select').value
                    });
                });
                
                return items;
            }
            
            // Extract action items button handler
            if (extractActionItemsBtn) {
                extractActionItemsBtn.addEventListener('click', function() {
                    // Show loading state
                    extractActionItemsBtn.disabled = true;
                    extractActionItemsBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Extracting...';
                    
                    // Make API request
                    fetch(`/api/transcripts/{{ transcript.id }}/action-items`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('API response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Store action items
                            currentActionItems = data.action_items || [];
                            
                            // Get both the original container and the new one in the tabbed interface
                            const actionItemsContainer1 = actionItemsContent.querySelector('div');
                            const actionItemsContainer2 = document.querySelector('#action-items-content-new div');
                            
                            // Clear both containers
                            if (actionItemsContainer1) actionItemsContainer1.innerHTML = '';
                            if (actionItemsContainer2) actionItemsContainer2.innerHTML = '';
                            
                            // Render action items in both containers
                            if (currentActionItems.length > 0) {
                                currentActionItems.forEach(item => {
                                    const itemElement = renderActionItem(item);
                                    if (actionItemsContainer1) actionItemsContainer1.appendChild(itemElement);
                                    if (actionItemsContainer2) {
                                        const itemClone = renderActionItem(item);
                                        actionItemsContainer2.appendChild(itemClone);
                                    }
                                });
                            } else {
                                const noItemsMsg = '<p class="text-gray-400">No action items found in the transcript.</p>';
                                if (actionItemsContainer1) actionItemsContainer1.innerHTML = noItemsMsg;
                                if (actionItemsContainer2) actionItemsContainer2.innerHTML = noItemsMsg;
                            }
                            
                            // Show the container
                            actionItemsContainer.classList.remove('hidden');
                            
                            // Show cached badge or save button
                            if (data.cached) {
                                actionItemsCachedBadge.classList.remove('hidden');
                                saveActionItemsBtn.classList.add('hidden');
                            } else {
                                actionItemsCachedBadge.classList.add('hidden');
                                saveActionItemsBtn.classList.remove('hidden');
                            }
                            
                            // Switch to the Results tab
                            window.switchTab('results');
                            
                            // Reset button
                            extractActionItemsBtn.disabled = false;
                            extractActionItemsBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg> Extract Action Items';
                        })
                        .catch(error => {
                            console.error('Error extracting action items:', error);
                            const errorMsg = 'Error extracting action items. Make sure Ollama is running locally.<br><span class="text-primary-400">Run: ollama serve</span>';
                            
                            // Update both containers with error message
                            if (actionItemsContent) actionItemsContent.innerHTML = errorMsg;
                            const newActionItemsContent = document.querySelector('#action-items-content-new');
                            if (newActionItemsContent) newActionItemsContent.innerHTML = errorMsg;
                            
                            actionItemsContainer.classList.remove('hidden');
                            
                            // Switch to the Results tab
                            window.switchTab('results');
                            
                            // Reset button
                            extractActionItemsBtn.disabled = false;
                            extractActionItemsBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg> Extract Action Items';
                        });
                });
                
                // Save button
                saveActionItemsBtn.addEventListener('click', function() {
                    // Show loading state
                    saveActionItemsBtn.disabled = true;
                    saveActionItemsBtn.textContent = 'Saving...';
                    
                    // Make API request to save
                    fetch(`/api/transcripts/{{ transcript.id }}/save-action-items`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action_items: currentActionItems
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show saved indicator
                            actionItemsCachedBadge.classList.remove('hidden');
                            saveActionItemsBtn.classList.add('hidden');
                        } else {
                            alert('Failed to save action items');
                        }
                        
                        // Reset button
                        saveActionItemsBtn.disabled = false;
                        saveActionItemsBtn.textContent = 'Save';
                    })
                    .catch(error => {
                        console.error('Error saving action items:', error);
                        alert('Error saving action items');
                        
                        // Reset button
                        saveActionItemsBtn.disabled = false;
                        saveActionItemsBtn.textContent = 'Save';
                    });
                });
                
                // Close button
                actionItemsCloseBtn.addEventListener('click', function() {
                    actionItemsContainer.classList.add('hidden');
                });
                
                // Setup action items editor
                function setupActionItemsEditor(button, contentElement) {
                    if (button) {
                        button.addEventListener('click', function() {
                            // Clear existing items
                            actionItemsEditor.innerHTML = '';
                            
                            // Add existing items to editor
                            if (currentActionItems.length > 0) {
                                currentActionItems.forEach(item => {
                                    actionItemsEditor.appendChild(createActionItemEditorElement(item));
                                });
                            } else {
                                // Add one empty item if none exist
                                actionItemsEditor.appendChild(createActionItemEditorElement());
                            }
                            
                            // Hide content and show editor
                            if (contentElement && contentElement.parentElement) {
                                contentElement.parentElement.classList.add('hidden');
                            }
                            actionItemsEditContainer.classList.remove('hidden');
                        });
                    }
                }
                
                // Setup both edit buttons
                setupActionItemsEditor(editActionItemsBtn, actionItemsContent);
                setupActionItemsEditor(editActionItemsBtnGenerated, document.querySelector('#action-items-content-new div'));
                
                // Add action item button
                actionItemsAddBtn.addEventListener('click', function() {
                    actionItemsEditor.appendChild(createActionItemEditorElement());
                });
                
                // Cancel editing button
                actionItemsEditCancel.addEventListener('click', function() {
                    actionItemsContent.parentElement.classList.remove('hidden');
                    actionItemsEditContainer.classList.add('hidden');
                });
                
                // Save edits button
                actionItemsEditSave.addEventListener('click', function() {
                    // Show loading state
                    actionItemsEditSave.disabled = true;
                    actionItemsEditSave.textContent = 'Saving...';
                    
                    // Collect data
                    const items = collectActionItemsData();
                    
                    // Update current items
                    currentActionItems = items;
                    
                    // Update display
                    actionItemsContent.innerHTML = '';
                    if (items.length > 0) {
                        items.forEach(item => {
                            actionItemsContent.appendChild(renderActionItem(item));
                        });
                    } else {
                        actionItemsContent.innerHTML = '<p class="text-gray-400">No action items found.</p>';
                    }
                    
                    // Save to server
                    fetch(`/api/transcripts/{{ transcript.id }}/save-action-items`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action_items: items
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show saved indicator
                            actionItemsCachedBadge.classList.remove('hidden');
                            saveActionItemsBtn.classList.add('hidden');
                            
                            // Show content and hide editor
                            actionItemsContent.parentElement.classList.remove('hidden');
                            actionItemsEditContainer.classList.add('hidden');
                        } else {
                            alert('Failed to save action items');
                        }
                        
                        // Reset button
                        actionItemsEditSave.disabled = false;
                        actionItemsEditSave.textContent = 'Save';
                    })
                    .catch(error => {
                        console.error('Error saving action items:', error);
                        alert('Error saving action items');
                        
                        // Reset button
                        actionItemsEditSave.disabled = false;
                        actionItemsEditSave.textContent = 'Save';
                    });
                });
                
                // Delete all button
                actionItemsEditDelete.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete all action items?')) {
                        // Show loading state
                        actionItemsEditDelete.disabled = true;
                        actionItemsEditDelete.textContent = 'Deleting...';
                        
                        // Clear
                        currentActionItems = [];
                        
                        // Save empty array to server
                        fetch(`/api/transcripts/{{ transcript.id }}/save-action-items`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                action_items: []
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Reload the page
                                window.location.reload();
                            } else {
                                alert('Failed to delete action items');
                                
                                // Reset button
                                actionItemsEditDelete.disabled = false;
                                actionItemsEditDelete.textContent = 'Delete All';
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting action items:', error);
                            alert('Error deleting action items');
                            
                            // Reset button
                            actionItemsEditDelete.disabled = false;
                            actionItemsEditDelete.textContent = 'Delete All';
                        });
                    }
                });
            }
            
            // Handle cancel button
            cancelDeleteBtn.addEventListener('click', function() {
                deleteModal.classList.add('hidden');
            });
            
            // Close modal on outside click
            deleteModal.addEventListener('click', function(event) {
                if (event.target === deleteModal) {
                    deleteModal.classList.add('hidden');
                }
            });
            
            // Handle confirm delete
            confirmDeleteBtn.addEventListener('click', function() {
                // Send delete request
                fetch(`/delete/{{ transcript.id }}`, {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Redirect to dashboard after successful deletion
                        window.location.href = '/dashboard';
                    } else {
                        alert('Error deleting transcript: ' + (data.error || 'Unknown error'));
                        deleteModal.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the transcript');
                    deleteModal.classList.add('hidden');
                });
            });
            
            // Check for search parameter in URL (coming from global search)
            const urlParams = new URLSearchParams(window.location.search);
            const urlSearchTerm = urlParams.get('search');
            
            if (urlSearchTerm) {
                // Set the search input value
                searchInput.value = urlSearchTerm;
                
                // Perform the search
                const results = highlightSearchTermInSegments(urlSearchTerm);
                
                // Update results display
                resultsList.innerHTML = '';
                results.forEach(result => {
                    const item = document.createElement('li');
                    item.className = 'p-2 rounded-lg hover:bg-dark-900 cursor-pointer';
                    
                    const time = document.createElement('div');
                    time.className = 'text-xs text-primary-400';
                    time.textContent = formatTime(result.start);
                    
                    // Get the text with highlighted search term
                    const textEl = document.createElement('p');
                    textEl.className = 'text-sm';
                    
                    const regex = new RegExp(`(${urlSearchTerm})`, 'gi');
                    const highlightedText = result.text.replace(regex, '<span class="bg-primary-900 text-primary-200">$1</span>');
                    textEl.innerHTML = highlightedText;
                    
                    item.appendChild(time);
                    item.appendChild(textEl);
                    
                    item.addEventListener('click', () => {
                        jumpToSegment(result.index);
                    });
                    
                    resultsList.appendChild(item);
                });
                
                // Update count and show results
                resultsCount.textContent = results.length;
                
                if (results.length > 0) {
                    searchResults.classList.remove('hidden');
                }
            }
            
            // Regular search functionality
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                // Clear existing highlights
                document.querySelectorAll('.segment-text').forEach((el, index) => {
                    el.textContent = segments[index].text;
                });
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                if (searchTerm.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                // Add a slight delay for better performance
                searchTimeout = setTimeout(() => {
                    // Search in segments and highlight matches
                    const results = highlightSearchTermInSegments(searchTerm);
                    
                    // Update results list
                    resultsList.innerHTML = '';
                    results.forEach(result => {
                        const item = document.createElement('li');
                        item.className = 'p-2 rounded-lg hover:bg-dark-900 cursor-pointer';
                        
                        const time = document.createElement('div');
                        time.className = 'text-xs text-primary-400';
                        time.textContent = formatTime(result.start);
                        
                        // Get the text with highlighted search term
                        const textEl = document.createElement('p');
                        textEl.className = 'text-sm';
                        
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        const highlightedText = result.text.replace(regex, '<span class="bg-primary-900 text-primary-200">$1</span>');
                        textEl.innerHTML = highlightedText;
                        
                        item.appendChild(time);
                        item.appendChild(textEl);
                        
                        item.addEventListener('click', () => {
                            jumpToSegment(result.index);
                        });
                        
                        resultsList.appendChild(item);
                    });
                    
                    // Update count and show results
                    resultsCount.textContent = results.length;
                    
                    if (results.length > 0) {
                        searchResults.classList.remove('hidden');
                    } else {
                        searchResults.classList.add('hidden');
                    }
                }, 300);
            });
            
            // Handle summary editing in the details section
            const editSummaryBtn = document.getElementById('edit-summary-btn');
            const summaryDisplay = document.getElementById('summary-display');
            const summaryEditForm = document.getElementById('summary-edit-form');
            const summaryEditTextarea = document.getElementById('summary-edit-textarea');
            const summaryEditCancel = document.getElementById('summary-edit-cancel');
            const summaryEditSave = document.getElementById('summary-edit-save');
            const summaryEditDelete = document.getElementById('summary-edit-delete');
            
            // Handle topic tag editing
            const editTopicTagBtn = document.getElementById('edit-topic-tag-btn');
            const topicTagDisplay = document.getElementById('topic-tag-display');
            const topicTagEditForm = document.getElementById('topic-tag-edit-form');
            const topicTagInput = document.getElementById('topic-tag-input');
            const topicTagCancel = document.getElementById('topic-tag-cancel');
            const topicTagSave = document.getElementById('topic-tag-save');
            
            if (editTopicTagBtn) {
                // Show edit form
                editTopicTagBtn.addEventListener('click', function() {
                    topicTagDisplay.classList.add('hidden');
                    topicTagEditForm.classList.remove('hidden');
                });
                
                // Cancel editing
                topicTagCancel.addEventListener('click', function() {
                    topicTagDisplay.classList.remove('hidden');
                    topicTagEditForm.classList.add('hidden');
                });
                
                // Save edited topic tag
                topicTagSave.addEventListener('click', function() {
                    const editedTopic = topicTagInput.value.trim();
                    
                    // Show loading state
                    topicTagSave.disabled = true;
                    topicTagSave.textContent = 'Saving...';
                    
                    fetch(`/api/transcripts/{{ transcript.id }}/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            topic: editedTopic
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update displayed topic
                            topicTagDisplay.textContent = editedTopic;
                            
                            // Hide edit form
                            topicTagDisplay.classList.remove('hidden');
                            topicTagEditForm.classList.add('hidden');
                        } else {
                            alert('Failed to save topic');
                        }
                        
                        // Reset button
                        topicTagSave.disabled = false;
                        topicTagSave.textContent = 'Save';
                    })
                    .catch(error => {
                        console.error('Error saving topic:', error);
                        alert('Error saving topic');
                        
                        // Reset button
                        topicTagSave.disabled = false;
                        topicTagSave.textContent = 'Save';
                    });
                });
            }
            
            if (editSummaryBtn) {
                // Initialize the textarea with current summary
                summaryEditTextarea.value = summaryDisplay.textContent.trim();
                
                // Show edit form
                editSummaryBtn.addEventListener('click', function() {
                    summaryDisplay.classList.add('hidden');
                    summaryEditForm.classList.remove('hidden');
                });
                
                // Cancel editing
                summaryEditCancel.addEventListener('click', function() {
                    summaryDisplay.classList.remove('hidden');
                    summaryEditForm.classList.add('hidden');
                });
                
                // Save edited summary
                summaryEditSave.addEventListener('click', function() {
                    const editedSummary = summaryEditTextarea.value.trim();
                    
                    // Show loading state
                    summaryEditSave.disabled = true;
                    summaryEditSave.textContent = 'Saving...';
                    
                    fetch(`/api/transcripts/{{ transcript.id }}/edit-summary`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            summary: editedSummary
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update displayed summary
                            summaryDisplay.textContent = editedSummary;
                            
                            // Update AI panel summary if it exists
                            if (summaryContent) {
                                currentSummary = editedSummary;
                                summaryContent.innerHTML = formatLLMOutput(editedSummary);
                            }
                            
                            // Hide edit form
                            summaryDisplay.classList.remove('hidden');
                            summaryEditForm.classList.add('hidden');
                        } else {
                            alert('Failed to save summary');
                        }
                        
                        // Reset button
                        summaryEditSave.disabled = false;
                        summaryEditSave.textContent = 'Save';
                    })
                    .catch(error => {
                        console.error('Error saving summary:', error);
                        alert('Error saving summary');
                        
                        // Reset button
                        summaryEditSave.disabled = false;
                        summaryEditSave.textContent = 'Save';
                    });
                });
                
                // Delete summary
                summaryEditDelete.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this summary?')) {
                        // Show loading state
                        summaryEditDelete.disabled = true;
                        summaryEditDelete.textContent = 'Deleting...';
                        
                        fetch(`/api/transcripts/{{ transcript.id }}/edit-summary`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                summary: ''
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Reload page to update UI
                                window.location.reload();
                            } else {
                                alert('Failed to delete summary');
                                
                                // Reset button
                                summaryEditDelete.disabled = false;
                                summaryEditDelete.textContent = 'Delete';
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting summary:', error);
                            alert('Error deleting summary');
                            
                            // Reset button
                            summaryEditDelete.disabled = false;
                            summaryEditDelete.textContent = 'Delete';
                        });
                    }
                });
            }
            
            // Automatically show summary and topics if they exist
            {% if transcript.summary %}
            // Pre-load the saved summary
            currentSummary = `{{ transcript.summary|safe }}`;
            summaryContent.innerHTML = formatLLMOutput(currentSummary);
            summaryContainer.classList.remove('hidden');
            document.getElementById('summary-cached').classList.remove('hidden');
            saveSummaryBtn.classList.add('hidden');
            {% endif %}
            
            {% if transcript.topics %}
            // Pre-load the saved topics
            currentTopics = {{ transcript.topics|tojson|safe }};
            let topicsHtml = '<div class="space-y-3">';
            
            currentTopics.forEach(topic => {
                topicsHtml += `<div>
                    <h5 class="font-medium text-primary-300">${topic.name}</h5>
                    <ul class="list-disc pl-5 space-y-1">`;
                
                topic.points.forEach(point => {
                    topicsHtml += `<li>${point}</li>`;
                });
                
                topicsHtml += `</ul></div>`;
            });
            
            topicsHtml += '</div>';
            topicsContent.innerHTML = topicsHtml;
            topicsContainer.classList.remove('hidden');
            document.getElementById('topics-cached').classList.remove('hidden');
            saveTopicsBtn.classList.add('hidden');
            {% endif %}
            
            // Check LLM availability
            fetch('/api/llm/status')
                .then(response => response.json())
                .then(data => {
                    if (!data.available) {
                        // If LLM is not available, disable the AI analysis buttons and show message
                        generateSummaryBtn.disabled = true;
                        extractTopicsBtn.disabled = true;
                        generateSummaryBtn.classList.add('opacity-50');
                        extractTopicsBtn.classList.add('opacity-50');
                        
                        const aiSection = document.querySelector('.bg-dark-800.rounded-xl.p-6.shadow-lg.mb-6:nth-of-type(2)');
                        const statusMsg = document.createElement('div');
                        statusMsg.className = 'text-xs text-red-400 mt-2';
                        statusMsg.innerHTML = 'Ollama LLM not available. To enable AI features, make sure Ollama is running by executing: <code>ollama serve</code>';
                        aiSection.appendChild(statusMsg);
                    } else {
                        // If available, show available models
                        const aiSection = document.querySelector('.bg-dark-800.rounded-xl.p-6.shadow-lg.mb-6:nth-of-type(2)');
                        const statusMsg = document.createElement('div');
                        statusMsg.className = 'text-xs text-green-400 mt-2';
                        
                        let modelsList = '';
                        if (data.models && data.models.length > 0) {
                            modelsList = `Available models: ${data.models.map(m => m.name).join(', ')}`;
                        }
                        
                        statusMsg.innerHTML = `Ollama LLM available. Using: ${data.default_model}. ${modelsList}`;
                        aiSection.appendChild(statusMsg);
                    }
                })
                .catch(error => {
                    console.error('Error checking LLM status:', error);
                });
        });
    </script>
</body>
</html>